{% extends 'layout.html' %}

{% set mainClasses = "nhsuk-main-wrapper--s" %}

{% block pageTitle %}
  Take a smartcard photo
{% endblock %}

{% block beforeContent %}
{% endblock %}

{% block outerContent %}
  {{ backLink({
    "href": "/applicant/v5/smartcard/format",
    "text": "Back",
    "classes": "nhsuk-u-margin-top-4 nhsuk-u-margin-bottom-0"
  }) }}
{% endblock %}

{% block content %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">
      <!-- Instructions -->
      <div id="instructions">
        <h1>Take a smartcard photo</h1>

        <p>Your smartcard photo must:</p>
        <ul>
          <li>be clear and in focus</li>
          <li>be taken against a plain, light coloured background</li>
          <li>show you facing forwards</li>
          <li>not contain other people or objects in the background</li>
          <li>not have hair or other objects obscuring the face</li>
        </ul>

        <form id="save-image" action="/applicant/v5/smartcard/check-your-answers" method="post">

          <div class="nhsuk-form-group nhsuk-u-visually-hidden">
            <label class="nhsuk-label" for="fileInput">
              Upload an image file
            </label>
            <div class="nhsuk-hint" id="example-with-hint-text-hint">
              Must be .jpeg, .jpg, .png, .bmp
            </div>
            <input type="file" id="fileInput" class="nhsuk-file-upload nhsuk-u-margin-top-3" name="fileInput">
          </div>
  
          <a id="take-photo-option" class="nhsuk-button" href="#00">Open camera</a>
      </div>
      
    </div>
  </div>

      <!-- Show the relevant bit depending on how they want to take a picture -->

      <!-- Photo booth -->

        <div id="photo-booth" style="display:none;" >

          <img id="photo" width="400" height="273" src="" style="display: none;" />


          <div class="nhsuk-grid-row nhsuk-u-margin-top-6 nhsuk-u-margin-bottom-4" >
            <div class="nhsuk-grid-column-one-half">
              <h2>
                Take photo
              </h2>
              <video id='target' width="500" height="400"></video>
              <a id="capture" class="nhsuk-button nhsuk-button--secondary nhsuk-u-margin-top-4">Take photo</a>
            </div>
            <div class="nhsuk-grid-column-one-third">
            </div>
          </div>


        </div>

        <!-- Photo edit -->

        <div id="image-editing" style="display: none;">
          <div class="nhsuk-grid-row">
            <div class="nhsuk-grid-column-two-thirds">
              <p><a href="#">Re-take photo</a></p>
            </div>
          </div>
          <div class="nhsuk-grid-row nhsuk-u-margin-bottom-4" >
  
            <div class="nhsuk-grid-column-one-half">
              
              <h2>
                Edit image
              </h2>
              <canvas width="400" height="273" id="edit-canvas" style="border: 1px #d8dde0 solid;">
                Browser doesn't support image editing
              </canvas>
              <p class="nhsuk-body-s nhsuk-u-margin-top-2 nhsuk-u-margin-bottom-2">
                Move: <a href="#01">Left</a> |
                <a href="#02">Right</a> |
                <a href="#03">Up</a> |
                <a href="#04">Down</a> |
                <a href="#05">Reduce</a> |
                <a href="067">Increase</a>
              </p>
              <p class="nhsuk-body-s">
                Rotate:
                <a href="#07">Clockwise</a> |
                <a href="#08">Anticlockwise</a>
              </p>
              <a class="nhsuk-button" href="/applicant/v5/smartcard/check-your-answers">Continue</a>
            </div>
            <div class="nhsuk-grid-column-one-third">
              <h2>
                Preview
              </h2>
              <canvas width="213" height="273" id="preview-canvas" style="border: 1px #d8dde0 solid;">
                Browser doesn't support image editing
              </canvas>
            </div>
          </div>


        </div>

      </div>

      </form>


      <script src="/js/jquery-3.3.1.min.js"></script>
      <script>

        var editCanvas = document.getElementById('edit-canvas');
        var previewCanvas = document.getElementById('preview-canvas');
        var ctx1 = editCanvas.getContext('2d');
        var ctx2 = previewCanvas.getContext('2d');

        // Trigger the imageLoader function when a file has been selected
        var fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', imageLoader, false);

        function imageLoader() {
            // $("#image-requirements").css("display", "none"); - Removed as trying out having it show at the top by default
            $("#image-editing").css("display", "block");
            var reader = new FileReader();
            reader.onload = function(event) {
                img = new Image();
                img.onload = function(){
                  // document.body.appendChild(img);
                  if (img.width < img.height) {

                    // get the scale
                    var scale = Math.min(editCanvas.width / img.width, editCanvas.height / img.height);
                    // get the top left position of the image
                    var x = (editCanvas.width / 2) - (img.width / 2) * scale;
                    var y = (editCanvas.height / 2) - (img.height / 2) * scale;
                    ctx1.drawImage(img, x, y, img.width * scale, img.height * scale);

                  } else {

                    // get the scale
                    var scale = Math.max(editCanvas.width / img.width, editCanvas.height / img.height);
                    // get the top left position of the image
                    var x = (editCanvas.width / 2) - (img.width / 2) * scale;
                    var y = (editCanvas.height / 2) - (img.height / 2) * scale;
                    ctx1.drawImage(img, x, y, img.width * scale, img.height * scale);

                  }

                  // Outer portrait image edge
                  ctx1.beginPath();
                  ctx1.lineWidth = "4";
                  ctx1.strokeStyle = "red";
                  ctx1.rect(94, 1, 213, 270);
                  ctx1.stroke();

                  // Resize container
                  ctx1.beginPath();
                  ctx1.lineWidth = "4";
                  ctx1.strokeStyle = "red";
                  ctx1.rect(267, 233, 40, 50);
                  ctx1.stroke();

                  // Resize arrow - smaller
                  ctx1.beginPath();
                  ctx1.moveTo(291, 242);
                  ctx1.lineTo(276, 242);
                  ctx1.lineTo(276, 257);
                  ctx1.closePath();
                  ctx1.fillStyle = "red";
                  ctx1.fill();

                  // Resize arrow - larger
                  ctx1.beginPath();
                  ctx1.moveTo(281, 261);
                  ctx1.lineTo(296, 261);
                  ctx1.lineTo(296, 246);
                  ctx1.closePath();
                  ctx1.fillStyle = "red";
                  ctx1.fill();

                  // Directional arrow - top
                  ctx1.beginPath();
                  ctx1.moveTo(190, 100);
                  ctx1.lineTo(210, 100);
                  ctx1.lineTo(200, 90);
                  ctx1.closePath();
                  ctx1.fillStyle = "red";
                  ctx1.fill();

                  // Directional arrow - right
                  ctx1.beginPath();
                  ctx1.moveTo(220, 110);
                  ctx1.lineTo(220, 130);
                  ctx1.lineTo(230, 120);
                  ctx1.closePath();
                  ctx1.fillStyle = "red";
                  ctx1.fill();

                  // Directional arrow - bottom
                  ctx1.beginPath();
                  ctx1.moveTo(190, 140);
                  ctx1.lineTo(210, 140);
                  ctx1.lineTo(200, 150);
                  ctx1.closePath();
                  ctx1.fillStyle = "red";
                  ctx1.fill();

                  // Directional arrow - Left
                  ctx1.beginPath();
                  ctx1.moveTo(180, 110);
                  ctx1.lineTo(180, 130);
                  ctx1.lineTo(170, 120);
                  ctx1.closePath();
                  ctx1.fillStyle = "red";
                  ctx1.fill();

                  // Directional centre point
                  ctx1.beginPath();
                  ctx1.arc(200, 120, 10, 0, 2 * Math.PI, false);
                  ctx1.fillStyle = "red";
                  ctx1.fill();

                  // Face placement guide
                  ctx1.beginPath();
                  ctx1.translate(1, 1);
                  ctx1.scale(0.75, 1);
                  ctx1.arc(265, 120, 80, 0, 2 * Math.PI, false);
                  ctx1.restore(); // restore to original state
                  ctx1.lineWidth = "4";
                  ctx1.strokeStyle = "red";
                  ctx1.stroke();
                  ctx1.strokeStyle = 'rgba(0,0,0,0.0)';

                  // get the scale
                  var scale = Math.max(previewCanvas.width / img.width, previewCanvas.height / img.height);
                  // get the top left position of the image
                  var x = (previewCanvas.width / 2) - (img.width / 2) * scale;
                  var y = (previewCanvas.height / 2) - (img.height / 2) * scale;
                  ctx2.drawImage(img, x, y, img.width * scale, img.height * scale);



                  var cw=editCanvas.width;
                  var ch=editCanvas.height;
                  function reOffset(){
                    var BB=editCanvas.getBoundingClientRect();
                    offsetX=BB.left;
                    offsetY=BB.top;
                  }
                  var offsetX,offsetY;
                  reOffset();
                  window.onscroll=function(e){ reOffset(); }
                  window.onresize=function(e){ reOffset(); }

                  var isDown=false;
                  var startX, startY;

                  var cursors=['default','pointer'];
                  var currentCursor=0;

                  var shapes=[];
                  shapes.push({
                    points:[{x:220,y:85},{x:310,y:85},{x:310,y:155},{x:220,y:155}],
                    cursor:1
                  });
                  shapes.push({
                    points:[{x:355,y:233},{x:407,y:233},{x:407,y:283},{x:355,y:283}],
                    cursor:1
                  });

                  for(var i=0;i<shapes.length;i++){
                    var s=shapes[i];
                    definePath(s.points);
                    ctx1.stroke();
                  }

                }
              img.src = reader.result;
            }
            reader.readAsDataURL(fileInput.files[0]);
        }


        /// Take photo functionality

        // Trigger the photo capture when link is pressed

        var video = document.getElementById('target'),
            canvas = document.getElementById('edit-canvas'),
            previewCanvas = document.getElementById('preview-canvas'),
            context = canvas.getContext('2d'),
            context2 = previewCanvas.getContext('2d'),
            photo = document.getElementById('photo'),
            takePhotoOption = document.getElementById('take-photo-option'),
            takePhoto = document.getElementById('capture'),
            photoBooth = document.getElementById('photo-booth'),
            editBooth = document.getElementById('image-editing');
            instructions = document.getElementById('instructions');

       takePhotoOption.addEventListener("click", function() {
         photoBooth.style.display = "block";
         editBooth.style.display = "none";
         instructions.style.display = "none";

         navigator.mediaDevices.getUserMedia({
           video: true,
           audio:false
         }).then( stream => {
           video.srcObject = stream;
           video.play();
         }).catch( error => console.log(error) );

         takePhoto.addEventListener("click", function() {
           context.drawImage(video, 0, 0, 400, 300);
           // Outer portrait image edge
           context.beginPath();
           context.lineWidth = "4";
           context.strokeStyle = "red";
           context.rect(94, 1, 213, 270);
           context.stroke();
           // Resize container
           context.beginPath();
           context.lineWidth = "4";
           context.strokeStyle = "red";
           context.rect(267, 233, 40, 50);
           context.stroke();
           // Resize arrow - smaller
           context.beginPath();
           context.moveTo(291, 242);
           context.lineTo(276, 242);
           context.lineTo(276, 257);
           context.closePath();
           context.fillStyle = "red";
           context.fill();
           // Resize arrow - larger
           context.beginPath();
           context.moveTo(281, 261);
           context.lineTo(296, 261);
           context.lineTo(296, 246);
           context.closePath();
           context.fillStyle = "red";
           context.fill();
           // Directional arrow - top
           context.beginPath();
           context.moveTo(190, 100);
           context.lineTo(210, 100);
           context.lineTo(200, 90);
           context.closePath();
           context.fillStyle = "red";
           context.fill();
           // Directional arrow - right
           context.beginPath();
           context.moveTo(220, 110);
           context.lineTo(220, 130);
           context.lineTo(230, 120);
           context.closePath();
           context.fillStyle = "red";
           context.fill();
           // Directional arrow - bottom
           context.beginPath();
           context.moveTo(190, 140);
           context.lineTo(210, 140);
           context.lineTo(200, 150);
           context.closePath();
           context.fillStyle = "red";
           context.fill();
           // Directional arrow - Left
           context.beginPath();
           context.moveTo(180, 110);
           context.lineTo(180, 130);
           context.lineTo(170, 120);
           context.closePath();
           context.fillStyle = "red";
           context.fill();
           // Directional centre point
           context.beginPath();
           context.arc(200, 120, 10, 0, 2 * Math.PI, false);
           context.fillStyle = "red";
           context.fill();
           // Face placement guide
           context.beginPath();
           context.translate(1, 1);
           context.scale(0.75, 1);
           context.arc(265, 120, 80, 0, 2 * Math.PI, false);
           context.restore(); // restore to original state
           context.lineWidth = "4";
           context.strokeStyle = "red";
           context.stroke();
           context.strokeStyle = 'rgba(0,0,0,0.0)';

           context2.drawImage(video, -96, 0, 400, 300);
           photo.setAttribute('src', canvas.toDataURL('image/png'));
           editBooth.style.display = "block";
           photoBooth.style.display = "none";
           takePhotoOption.innerHTML = "Retake photo";
         })

       });


        $("#save-image").on("submit", function(e) {
          e.preventDefault();
          var previewCanvas = document.getElementById('preview-canvas');
          var imgDataURL = previewCanvas.toDataURL("image/png");
          console.log("data url: " + imgDataURL);
          localStorage.setItem("createUserImgDataURL", imgDataURL);
          window.location.href = "/v14/create-new-user/check-answers";
        });


      </script>


    </div>
  </div>

{% endblock %}
